# JavaScript-Deobjuscation

## Source Code
### Notes
Source Code
- JavaScript: powers functionality, most websites use JavaScript to handle interactive and functional tasks behind the scenes.
- HTML: defines the structure and fields of a website.
- CSS: controls the visual design and layout.
- Client-side execution: JavaScript runs in the background, creating dynamic experiences, while users only interact with the rendered front-end.
- Source code is accessible, although it's executed on the client side, it's all accessible through the browser.
- Analyzing web pages:
  - To understand how a web page works on the client side, start by reviewing the page’s source code.
  - This helps uncover the logic and features implemented through JavaScript and HTML.

HTML
- Use 'Ctrl + U' to open the source view of the page

CSS
- Definition
  - Internal: will be found in the 'Style' field
  - External: will be in the 'link' tag in the HTML 'Head'

JavaScript
- Definition
  - Internal: will be written in between the 'script' elements
  - External: will be referenced in the 'script' tag
- If a JS code is very complicated and difficult to read, then they might be using deobfuscation
  - This includes code structure, or names of variables

### Walkthrough
Q1. Repeat what you learned in this section, and you should find a secret flag, what is it?
- Visit the website: http://SERVER_IP:PORT
  - Replace the IP and Port with the one generated by HTB
- Open the source view of the page with 'Ctrl + U'
- The flag will be a comment
- Answer is: HTB{4lw4y5_r34d_7h3_50urc3}

## Code Obfuscation
### Notes
What is Obfuscation?
- Definition:
  - Obfuscation is the process of making code harder for humans to read, while maintaining its original functionality.
  - It may slightly reduce performance due to added complexity.
- How it's done:
  - Typically performed by automated tools.
  - These tools rewrite code using techniques like converting code elements into dictionary references, then rebuilding them at runtime.
- Target languages:
  - Common with interpreted languages (e.g., Python, PHP, JavaScript) that aren’t compiled before execution.
  - Python and PHP are usually server-side (hidden from users), so it's usually not needed
  - JavaScript is client-side, meaning users can view and access it directly—making it a prime candidate for obfuscation.
- Purpose of obfuscation in JavaScript:
  - Prevent users from easily understanding or tampering with the code.
  - Often used to protect intellectual property or conceal malicious behavior.

Use Cases
- Reasons for obfuscation:
  - Code protection: Prevent others from copying or reusing code without permission.
  - Reverse engineering deterrence: Make it harder to analyze or understand the code’s original logic.
  - Security enhancement: Obfuscate sensitive logic related to authentication or encryption.
- Caveat: performing authentication or encryption on the client-side (like in JavaScript) is not recommended, as the code is easily accessible and more vulnerable to attacks.
- Malicious use cases:
  - Attackers frequently use obfuscation to hide the purpose of their scripts.
  - This helps evade Intrusion Detection and Prevention Systems (IDPS).

## Basic Obfuscation
### Notes
- Code obfuscation is typically automated.
- Various tools exist for different programming languages, including many online options.
- Malicious actors and professional developers often create custom obfuscation tools to make deobfuscation harder.

Minifying
- Minification is a technique used to reduce code readability while maintaining full functionality.
- Typically compresses code into a single long line, removing all unnecessary spaces, line breaks, and comments.
- Particularly useful for longer scripts, where it significantly reduces size and improves load performance.
  - For short, single-line code, minification doesn’t make much visible difference.
- Not exclusive to JS, can be applied to other languages
  - Online Tool: https://javascript-minifier.com/
- Usually, minified JS code is saved with the extension .min.js.

Packing
- Packer obfuscation tools convert all words and symbols in code into a list or dictionary.
  - Online Tool: http://beautifytools.com/javascript-obfuscator.php
- These tools then use a (p,a,c,k,e,d) function (or a variant) to reconstruct the original code at runtime.
  - It also defines the order in which elements are unpacked and reassembled.
- While packers effectively reduce readability, they often leave main strings in cleartext, potentially exposing parts of the code’s functionality.
  - More advanced obfuscation methods may be preferred for better concealment.

## Advanced Obfuscation
### Notes
- Basic obfuscation still contains cleartext strings.
- Visible strings may reveal the original functionality of the code.
- Advanced obfuscation tools aim to completely hide the code’s purpose, including removing or disguising any cleartext elements.

Obfuscator
- Online Tool: https://obfuscator.io/
- More obfuscated, and can't see any remnants of our original code
  - Used String Array Encoding: Base64, as example

More Obfuscation
- Can obfuscate JavaScript code using tools like JSF and then rerun it to test functionality.
  - Link: http://www.jsfuck.com/
- Obfuscated code may take longer to run, highlighting how obfuscation can negatively affect performance.
- Other obfuscators: JJ Encode (https://utf-8.jp/public/jjencode.html) or AA Encode (https://utf-8.jp/public/aaencode.html)
  - Can make execution or compilation extremely slow, so they are generally not recommended unless there's a specific reason, such as:
    - Bypassing web filters
    - Evading restrictions

## Deobfuscation
### Notes
- If there are tools for obfuscation, then there are also tools for deobfuscation

Beautify
- To undo the effect of Minify, you can use Beautify from the Browser Dev Tools
- Other Tools: Prettier (https://prettier.io/playground/) and Beautifier (https://beautifier.io/)
- This only changes the format to make it easier to read, not undo the deeper obfuscation such as Packing 

Deobfuscate
- Other Tools: UnPacker (https://matthewfl.com/unPacker.html)
- Another way of unpacking obfuscated code is to find the return value at the end and use console.log to print it instead of executing it.

Reverse Engineering
- Basic obfuscation tools are effective at cleaning up simple obfuscated code.
- As code becomes more heavily obfuscated or encoded, especially with custom obfuscation tools, it becomes harder for automated tools to deobfuscate.
- In such advanced cases, manual reverse engineering is required to:
  - Understand how the code was obfuscated.
  - Determine the original functionality.
- For deeper learning, refer to the Secure Coding 101 module, which covers:
  - Advanced JavaScript deobfuscation
  - Reverse engineering techniques.

### Walkthrough
Q1. Using what you learned in this section, try to deobfuscate 'secret.js' in order to get the content of the flag. What is the flag?
- Visit the website: http://SERVER_IP:PORT
  - Replace the IP and Port with the one generated by HTB
- Open the source view of the page with 'Ctrl + U'
- Click on the secret.js to open the JS in another windows.
- Copy all the obfuscated JS code
- Open the online Unpacker tool
- Paste the code and deobfuscate
- Answer is in the variable 'flag'
- Answer is: HTB{1_4m_7h3_53r14l_g3n3r470r!}

## Code Analysis
### Notes
JS Code
  'use strict';
  function generateSerial() {
    ...SNIP...
    var xhr = new XMLHttpRequest;
    var url = "/serial.php";
    xhr.open("POST", url, true);
    xhr.send(null);
  };

HTTP Requests Analysis
- Code Variables:
  - A variable xhr is defined to create an XMLHttpRequest object.
    - This object is used in JavaScript to handle web requests.
  - A second variable URL is set to /serial.php, implying the file exists on the same domain (no domain specified).
- Code Functions:
  - The function calls xhr.open("POST", URL) to set up a POST request.
  - It then uses xhr.send() to send the request, with no POST data included and no data expected in return.

Function Purpose & Developer Intent
- The generateSerial function likely exists to send a POST request to generate a serial.
- It may be tied to a future feature (e.g., a "Generate Serial" button) not yet implemented in the HTML.

Security & Testing Implications
- Through code deobfuscation and analysis, this hidden function was uncovered.
- By replicating the request manually, it may be possible to:
  - Test if the function is handled on the server-side.
  - Discover unreleased features.
  - Possibly find bugs or vulnerabilities.

## HTTP Requests
### Notes
cURL
- A CMD command
- Can request any website by simply providing its URL, and we would get it in text-format
  - The HTML, CSS and JS
- E.g. curl http://SERVER_IP:PORT/

POST Request
- To send a POST request, add the -X POST flag to the command
  - "-s" flag to reduce cluttering the response with unnecessary data
  - curl -s http://SERVER_IP:PORT/ -X POST
- POST request usually contains POST data. To send data, we can use the "-d "param1=sample"" flag and include the data for each parameter
  - curl -s http://SERVER_IP:PORT/ -X POST -d "param1=sample"

### Walkthrough
Q1. Try applying what you learned in this section by sending a 'POST' request to '/serial.php'. What is the response you get?
- Open PowerShell
- Run the POST command
  - curl -s http://SERVER_IP:PORT/serial.php -X POST
    - /serial.php was part of the main domain of Serial Generator, a subdomain
- Answer is: N2gxNV8xNV9hX3MzY3IzN19tMzU1NGcz

## Decoding
### Notes
What if?
- http://SERVER_IP:PORT/serial.php -X POST -d "param1=sample"
- But CMD replies with: ZG8gdGhlIGV4ZXJjaXNlLCBkb24ndCBjb3B5IGFuZCBwYXN0ZSA7KQo=

Explanation
- Obfuscation can be taken further using advanced techniques to make code harder to read and detect.
- These techniques often involve encoding parts of the code as text blocks that are decoded during execution.
- Such encoded blocks are commonly found in obfuscated code used to evade detection.
- Three common text encoding methods used in obfuscation are: Base64, Hex, ROT13

Base64
- This encoding reduces the use of special characters by representing data in:
  - Alphanumeric characters (A–Z, a–z, 0–9)
  - Two symbols: + and /
- It can encode any input, including binary data, into this restricted character set.

Spotting Base64
- Typically easy to recognize because:
  - They contain only alphanumeric characters, plus + and /.
  - They often end with = padding characters, used to make the total length a multiple of 4.
    - Example: If the output is 3 characters, 1 = is added.
    - If the output is 2 characters, 2 = are added.

Base64 Encode
- To encode any text into base64 in Linux, echo it and pipe it with '|' to base64: echo https://www.hackthebox.eu/ | base64
  - aHR0cHM6Ly93d3cuaGFja3RoZWJveC5ldS8K

Base64 Decode
- To decode any base64 encoded string, use base64 -d: echo aHR0cHM6Ly93d3cuaGFja3RoZWJveC5ldS8K | base64 -d
  - https://www.hackthebox.eu/

Hex
- Converts each character into its hexadecimal (base-16) representation based on the ASCII table.
  - E.g. 'a' → 61, 'b' → 62, 'c' → 63
- View the ASCII table on Linux using: man ascii

Spotting Hex
- Easy to recognize because:
  - They consist only of hexadecimal characters: 0–9 and a–f.
  - Their uniform character set makes them visually distinct, like base64.

Hex Encode
- To encode any string into hex in Linux, use the xxd -p: echo https://www.hackthebox.eu/ | xxd -p
  - 68747470733a2f2f7777772e6861636b746865626f782e65752f0a

Hex Decode
- To decode a hex encoded string, use the xxd -p -r: echo 68747470733a2f2f7777772e6861636b746865626f782e65752f0a | xxd -p -r
  - https://www.hackthebox.eu/

Caesar
- An ancient encoding technique where each letter is shifted by a fixed number of positions in the alphabet.
- E.g. With a shift of 1: 'a' → 'b', 'b' → 'c', etc.
- Variations use different shift values.
  - Rot13
    - The most common Caesar cipher variant.
    - Shifts letters 13 positions forward.
    - It's reversible by applying the same operation again.

Spotting Caesar/Rot13
- Encoded text may look random, but:
  - Each character is predictably mapped, maintaining structure.
  - E.g: http://www becomes uggc://jjj in Rot13.
  - Familiar patterns (like ://) may still hint at the original content.

Rot13 Encode
- No specific command, but can create own command to do the character shifting: echo https://www.hackthebox.eu/ | tr 'A-Za-z' 'N-ZA-Mn-za-m'
  - uggcf://jjj.unpxgurobk.rh/

Rot13 Decode
- Can use the same previous command to decode Rot13: echo uggcf://jjj.unpxgurobk.rh/ | tr 'A-Za-z' 'N-ZA-Mn-za-m'
  - https://www.hackthebox.eu/

Other Types of Encoding
- Numerous Encoding Methods:
  - There are hundreds of encoding techniques.
  - Experience may be required to recognize and decode less common ones.
- Identifying Unknown Encodings:
  - First, try to identify the encoding type.
  - Then use online decoding tools to interpret the data.
- Helpful Tool:
  - Tools like Cipher Identifier can automatically detect the encoding type.
    - https://www.boxentriq.com/code-breaking/cipher-identifier
  - Can test encoded strings using it to identify the method used.
- Obfuscation via Encryption:
  - Some obfuscation tools go further and use encryption (not just encoding).
  - Encryption uses a key, making it much harder to reverse-engineer.
  - If the decryption key isn’t embedded in the script, the code becomes very difficult to deobfuscate.

### Walkthrough
Q1. Using what you learned in this section, determine the type of encoding used in the string you got at previous exercise, and decode it. To get the flag, you can send a 'POST' request to 'serial.php', and set the data as "serial=YOUR_DECODED_OUTPUT".
- Open Cipher Identifier (https://www.boxentriq.com/code-breaking/cipher-identifier) and identify the encoder of the answer from previous section
- Decode the previous answer using Base64
  - echo N2gxNV8xNV9hX3MzY3IzN19tMzU1NGcz | base64 -d
- Copy the reply and run the POST request again on /serial.php
  - curl -s http://SERVER_IP:PORT/serial.php -X POST -d "serial=7h15_15_a_s3cr37_m3554g3" 
- Answer is: HTB{ju57_4n07h3r_r4nd0m_53r14l}
